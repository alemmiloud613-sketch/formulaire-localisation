<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire avec Localisation Automatique</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        .location-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .success { background: #e6f4ea; color: #137333; border: 1px solid #34a853; }
        .error { background: #fce8e6; color: #c5221f; border: 1px solid #ea4335; }
        .loading { background: #e8f0fe; color: #1a73e8; border: 1px solid #4285f4; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: #3367d6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .form-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- √âtape Localisation -->
        <div class="location-card" id="locationStep">
            <h2>üìç Localisation Automatique</h2>
            <p style="margin: 10px 0; color: #5f6368;">
                Nous avons besoin de votre position pour traiter votre demande.
            </p>
            
            <div id="locationStatus" class="status loading">
                <p>üîÑ Pr√©paration de la d√©tection de localisation...</p>
            </div>

            <button onclick="startLocationProcess()" id="locationBtn">
                üîç D√©tecter Ma Position Automatiquement
            </button>

            <div id="successSection" class="hidden">
                <div class="status success">
                    <p>‚úÖ Position d√©tect√©e avec succ√®s !</p>
                    <p id="locationDetails" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
                <button onclick="showForm()" id="continueBtn">
                    ‚û°Ô∏è Continuer vers le Formulaire
                </button>
            </div>

            <div id="errorSection" class="hidden">
                <div class="status error">
                    <p>‚ùå Impossible de d√©tecter automatiquement votre position</p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Veuillez nous indiquer votre ville manuellement :
                    </p>
                </div>
                <input type="text" id="manualCity" placeholder="Entrez votre ville" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <button onclick="useManualLocation()">‚úÖ Utiliser cette ville</button>
            </div>
        </div>

        <!-- Formulaire Google Forms -->
        <div class="form-container hidden" id="formStep">
            <h2>üìã Formulaire de Contact</h2>
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdXfa6fpkstuILCClpU7ZpNpP70KAI1GFlV2EkdN_VIXAFXDQ/viewform?embedded=true" 
                    frameborder="0" marginheight="0" marginwidth="0">
                Chargement‚Ä¶
            </iframe>
            <button onclick="goBack()" style="background: #5f6368; margin-top: 10px;">
                ‚Ü©Ô∏è Retour √† la localisation
            </button>
        </div>
    </div>

    <script>
        let userLocation = null;

        function startLocationProcess() {
            const statusDiv = document.getElementById('locationStatus');
            const locationBtn = document.getElementById('locationBtn');
            
            statusDiv.className = 'status loading';
            statusDiv.innerHTML = '<p>üîÑ D√©tection de votre position en cours...</p>';
            locationBtn.disabled = true;
            locationBtn.textContent = 'D√©tection en cours...';

            // Utiliser une approche plus agressive pour la g√©olocalisation
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    // Succ√®s
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        userLocation = { lat, lng };
                        
                        // Convertir en adresse
                        getAddressFromCoords(lat, lng);
                    },
                    // Erreur
                    function(error) {
                        handleLocationError(error);
                    },
                    options
                );
            } else {
                showManualOption();
            }
        }

        function getAddressFromCoords(lat, lng) {
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = '<p>üîÑ Conversion de la position en adresse...</p>';

            // Utiliser un service de g√©ocodage gratuit
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=fr`)
                .then(response => response.json())
                .then(data => {
                    const city = data.city || data.locality || 'Ville inconnue';
                    const country = data.countryName || '';
                    const address = `${city}, ${country}`;
                    
                    userLocation.address = address;
                    
                    // Afficher le succ√®s
                    showSuccess(address);
                })
                .catch(error => {
                    // Fallback aux coordonn√©es
                    userLocation.address = `Position: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    showSuccess(userLocation.address);
                });
        }

        function showSuccess(address) {
            document.getElementById('locationDetails').textContent = address;
            document.getElementById('successSection').classList.remove('hidden');
            document.getElementById('locationStatus').classList.add('hidden');
        }

        function handleLocationError(error) {
            console.log('Erreur g√©olocalisation:', error);
            showManualOption();
        }

        function showManualOption() {
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('locationStatus').classList.add('hidden');
            document.getElementById('locationBtn').disabled = false;
            document.getElementById('locationBtn').textContent = 'üîç R√©essayer la d√©tection automatique';
        }

        function useManualLocation() {
            const manualCity = document.getElementById('manualCity').value;
            if (!manualCity) {
                alert('Veuillez entrer votre ville');
                return;
            }
            userLocation = { address: manualCity, manual: true };
            showSuccess(manualCity);
        }

        function showForm() {
            // Stocker la localisation pour utilisation ult√©rieure
            if (userLocation) {
                localStorage.setItem('userLocation', JSON.stringify(userLocation));
            }
            
            document.getElementById('locationStep').classList.add('hidden');
            document.getElementById('formStep').classList.remove('hidden');
        }

        function goBack() {
            document.getElementById('formStep').classList.add('hidden');
            document.getElementById('locationStep').classList.remove('hidden');
        }

        // D√©marrer automatiquement au chargement
        window.addEventListener('load', function() {
            // Essayer la d√©tection automatique apr√®s 1 seconde
            setTimeout(startLocationProcess, 1000);
        });
    </script>
</body>
</html>
